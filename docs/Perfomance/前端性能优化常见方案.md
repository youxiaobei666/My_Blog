# 前端性能优化常见方案

## 1. 减少页面回流(reflow)和重绘(repaint)

:::tip
**概念解释**

回流：当 Render Tree 中部分或全部元素的尺寸、结构、或某些属性发生改变时，浏览器重新渲染部分或全部文档的过程称为回流。

重绘：当页面中元素样式的改变并不影响它在文档流中的位置时（例如：color、background-color、visibility 等），浏览器会将新样式赋予给元素并重新绘制它，这个过程称为重绘。

回流是一定会引起重绘的，回流的代价比重绘更大。
:::

### 1.1 回流

**会导致回流的操作：**

页面首次渲染
浏览器窗口大小发生改变
元素尺寸或位置发生改变
元素内容变化（文字数量或图片大小等等）
元素字体大小变化
添加或者删除可见的 DOM 元素
激活 CSS 伪类（例如：:hover）
查询某些属性或调用某些方法

### 1.2 优化方案

CSS:

- 避免使用 table 布局。

- 尽可能在 DOM 树的最末端改变 class。

- 避免设置多层内联样式。

- 将动画效果应用到 position 属性为 absolute 或 fixed 的元素上。

- 避免使用 CSS 表达式（例如：calc()）。

- DOM 元素上下移动用用 translate 替代 top 修改。

- 元素适当地定义高度或最小高度，否则元素的动态内容载入时，会出现页面元素的晃动或位置，造成回流（比如图片要定义宽高，避免页面塌陷，同时减少回流。

- 减少使用层级较深的选择器，或其他一些复杂的选择器，以提高 CSS 渲染效率。

JavaScript:

- 避免频繁操作样式，最好一次性重写 style 属性，或者将样式列表定义为 class 并**一次性更改 class 属性**。

- 也可以先为元素设置 display: none，操作结束后再把它显示出来。因为在 display 属性为 none 的元素上进行的 DOM 操作不会引发回流和重绘。

- 对具有复杂动画的元素使用绝对定位，使它脱离文档流，否则会引起父元素及后续元素频繁回流。

- 避免频繁操作 DOM，创建一个 documentFragment，在它上面应用所有 DOM 操作，最后再把它添加到文档中。

- 避免频繁读取会引发回流/重绘的属性，如果确实需要多次使用，就用一个变量缓存起来。

## 2. 图片压缩，图片分割，精灵图

### 2.1 图片压缩

推荐使用网站：[tinyPng](https://tinypng.com/)

### 2.2 图片分割

如果页面需要加载一张比较大的图片，先分割，然后再用 css 布局将图片拼接到一起。

### 2.3 精灵图

与图片分割相反，精灵图是将很多小图片合并到一张大图里，使用 position 移动图片的位置来显示其中一部分图片，这样可以减少服务器的压力，不会请求太多次的图片。

## 3. 字体包压缩

问题描述： 完整使用字体的时候可能会阻塞页面，提取部分字体解决此问题。

### 3.1 font-spider

字蛛是一个智能 WebFont 压缩工具，它能自动分析出页面使用的 WebFont 并进行按需压缩。

## 4. 懒加载/预加载

### 4.1 图片懒加载

简言之就是只有当图片出现在浏览器的可视区域内时，才加载图片让图片显示出来（在此之前可以将所有图片元素的路径全都统一设置成一张 1\*1px 的占位图）。

判断图片出现在浏览器可视区域的方法：图片距离顶部的高度 `offsetTop` - `页面被卷去的高度scrollTop` <= 浏览器的可视区域的高度 `innerHeight`

### 4.2 资源预加载

预加载： Resource Hints(资源预加载)包括预连接、资源与获取、资源预渲染等。
预加载的思路有如下两个：
当前将要获取资源的列表;
通过当前页面或应用的状态、用户历史行为或 session 预测用户行为及必需的资源.

## 5. 打包优化

### 5.1 配置别名 alias

作用：

- 减少查找到过程
- 方便书写代码

### 5.2 配置后缀列表 resolve.extensions

后缀尝试列表要尽可能的小，不要把项目中不可能存在的情况写到后缀尝试列表中，频率出现最高的文件后缀要优先放在最前面，以做到尽快的退出寻找过程

### 5.3 loader 配置 include 或者 except

loader 是很消耗性能的一个点，我们在配置 loader 的时候，可以使用 include 和 except 来缩小 loader 执行范围，从而优化性能

```js
{
    test: /\.svg$/,
    loader: 'svg-sprite-loader',
    include: [resolve('src/icons')]
 },
```

### 5.4 tree shaking

导入的时候不要完整的导入一个包，可以导入其中的某个方法，打包的时候就不会打包其他无用的代码。

### 5.5 生产环境配置项

- 关闭生成 map 文件

- 生产环境移除 `console.log ` drop_console drop_debugger

- 关闭文件计算

## 6. 总体优化

### 6.1 SSR 服务端渲染

`SSR(Server Side Rendering)`，即服务端渲染。它指的是渲染过程在服务端完成，最终的渲染结果 HTML 页面通过 HTTP 协议发送给客户端，又叫“同构“。

好处：SEO 和首屏加载速度提升

Vue 使用 Nuxt.js

### 6.2 开启 gzip

Gzip 对文件进行压缩，能大大提高首屏加载速度，对于纯文本文件我们可以至少压缩到原大小的 40%,图片最好不要进行 gzip 压缩

### 6.3 路由懒加载/组件异步加载

```js
// 1. import懒加载
() => import('@/pages/xxx.vue')
// 2. 使用require
resolve => require(['@/pages/xxx.vue'], resolve),
```
